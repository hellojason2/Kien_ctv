<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTV Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #e8e8e8;
            color: #1a1a1a;
            min-height: 100vh;
        }

        /* ═══════════════════════════════════════════════════════════════════
           LOGIN PAGE
           ═══════════════════════════════════════════════════════════════════ */
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: #ffffff;
            border-radius: 16px;
            padding: 48px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .login-logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-logo svg {
            width: 100%;
            height: 100%;
        }

        .login-box h1 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .login-box .subtitle {
            text-align: center;
            color: #666666;
            margin-bottom: 32px;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666666;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1a1a1a;
            background: #ffffff;
        }

        .form-group input::placeholder {
            color: #999999;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #333333;
        }

        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #1a1a1a;
            cursor: pointer;
        }

        .remember-me label {
            font-size: 14px;
            color: #666666;
            cursor: pointer;
            margin: 0;
        }

        .error-msg {
            color: #dc3545;
            font-size: 14px;
            margin-top: 16px;
            text-align: center;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        /* Login Success Animation */
        .login-success {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .login-success.show {
            display: block;
        }

        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .success-checkmark svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: checkDraw 0.5s ease forwards 0.3s;
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        @keyframes checkDraw {
            to { stroke-dashoffset: 0; }
        }

        .success-text {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .success-subtext {
            color: #666666;
            font-size: 14px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           PORTAL LAYOUT
           ═══════════════════════════════════════════════════════════════════ */

        .portal {
            display: none;
        }

        .portal.active {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 80px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px;
            gap: 20px;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
        }

        .sidebar-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .sidebar-icon:hover {
            background-color: #ebebeb;
        }

        .sidebar-icon.active {
            background-color: #1a1a1a;
        }

        .sidebar-icon svg {
            width: 24px;
            height: 24px;
            stroke: #666666;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .sidebar-icon.active svg {
            stroke: #ffffff;
        }

        .sidebar-logout {
            margin-top: auto;
            margin-bottom: 30px;
        }

        .sidebar-logout:hover {
            background-color: #fee2e2;
        }

        .sidebar-logout:hover svg {
            stroke: #dc3545;
        }

        /* Main Content Area */
        .main-wrapper {
            flex: 1;
            margin-left: 80px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background-color: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo svg {
            width: 48px;
            height: 48px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-name {
            font-weight: 600;
            color: #1a1a1a;
        }

        .user-badge {
            background: #f5f5f5;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #666666;
        }

        .user-badge.gold { color: #d97706; background: #fef3c7; }
        .user-badge.silver { color: #6b7280; background: #f3f4f6; }
        .user-badge.bronze { color: #92400e; background: #fde68a; }

        /* Content Area */
        .content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .card-body {
            padding: 24px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .stat-card .label {
            font-size: 14px;
            color: #666666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-card.green .value { color: #22c55e; }
        .stat-card.blue .value { color: #3b82f6; }
        .stat-card.gold .value { color: #d97706; }
        .stat-card.pink .value { color: #ec4899; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            padding: 14px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #666666;
            text-transform: capitalize;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 16px 20px;
            font-size: 14px;
            color: #1a1a1a;
        }

        /* Commission Items */
        .commission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .commission-item:last-child {
            border-bottom: none;
        }

        .commission-item .left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .commission-item .level-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .commission-item .info {
            font-size: 14px;
            color: #1a1a1a;
        }

        .commission-item .date {
            font-size: 12px;
            color: #999999;
            margin-top: 2px;
        }

        .commission-item .amount {
            font-size: 16px;
            font-weight: 600;
            color: #22c55e;
        }

        /* Level Badges */
        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .level-0 { background: #dcfce7; color: #22c55e; }
        .level-1 { background: #dbeafe; color: #3b82f6; }
        .level-2 { background: #fef3c7; color: #d97706; }
        .level-3 { background: #fce7f3; color: #ec4899; }
        .level-4 { background: #ede9fe; color: #8b5cf6; }

        /* Tree Nodes */
        .tree-node {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 8px 0;
        }

        .tree-node .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-node .name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .tree-node .info {
            font-size: 13px;
            color: #666666;
            margin-top: 4px;
        }

        .tree-children {
            margin-left: 24px;
            padding-left: 20px;
            border-left: 2px solid #e0e0e0;
        }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            background-color: #fafafa;
            outline: none;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .search-input:focus {
            border-color: #1a1a1a;
            background-color: #ffffff;
        }

        .search-container svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            stroke: #999999;
        }

        /* Result Items */
        .result-item {
            background: #fafafa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .result-item .type {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #3b82f6;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .result-item .name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .result-item .details {
            font-size: 13px;
            color: #666666;
        }

        /* Select */
        select {
            padding: 10px 16px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #999999;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
                padding-top: 20px;
            }

            .sidebar-icon {
                width: 40px;
                height: 40px;
            }

            .main-wrapper {
                margin-left: 60px;
            }

            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 50px;
            }

            .main-wrapper {
                margin-left: 50px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10 L80 30 L80 70 L50 90 L20 70 L20 30 Z" stroke="#1a1a1a" stroke-width="3" fill="none"/>
                    <path d="M50 10 L50 90" stroke="#1a1a1a" stroke-width="3"/>
                    <path d="M20 30 L80 70" stroke="#1a1a1a" stroke-width="3"/>
                    <path d="M20 70 L80 30" stroke="#1a1a1a" stroke-width="3"/>
                </svg>
            </div>
            <h1>CTV Portal</h1>
            <p class="subtitle">Đăng nhập để xem hoa hồng và mạng lưới</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label>Mật khẩu</label>
                    <input type="password" id="password" placeholder="Nhập mật khẩu" required>
                </div>
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Ghi nhớ đăng nhập</label>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">Đăng Nhập</button>
                <div class="error-msg" id="loginError"></div>
            </form>

            <!-- Success Animation -->
            <div class="login-success" id="loginSuccess">
                <div class="success-checkmark">
                    <svg viewBox="0 0 24 24">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="success-text">Đăng nhập thành công!</div>
                <div class="success-subtext">Đang chuyển hướng...</div>
            </div>
        </div>
    </div>

    <!-- Portal -->
    <div class="portal" id="portal">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-icon active" data-page="dashboard" title="Tổng Quan">
                <svg viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                </svg>
            </div>
            <div class="sidebar-icon" data-page="earnings" title="Hoa Hồng">
                <svg viewBox="0 0 24 24">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="sidebar-icon" data-page="network" title="Mạng Lưới">
                <svg viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="sidebar-icon" data-page="search" title="Tìm Kiếm">
                <svg viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>
            <div class="sidebar-icon sidebar-logout" id="logoutBtn" title="Đăng Xuất">
                <svg viewBox="0 0 24 24">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-wrapper">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <div class="header-logo">
                        <svg viewBox="0 0 100 100" fill="none">
                            <path d="M50 10 L80 30 L80 70 L50 90 L20 70 L20 30 Z" stroke="#1a1a1a" stroke-width="3" fill="none"/>
                            <path d="M50 10 L50 90" stroke="#1a1a1a" stroke-width="3"/>
                            <path d="M20 30 L80 70" stroke="#1a1a1a" stroke-width="3"/>
                            <path d="M20 70 L80 30" stroke="#1a1a1a" stroke-width="3"/>
                        </svg>
                    </div>
                    <span class="header-title">CTV Portal</span>
                </div>
                <div class="header-right">
                    <span class="user-name" id="userName">-</span>
                    <span class="user-badge" id="userLevel">-</span>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div class="page-section active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card green">
                            <div class="label">Tổng Thu Nhập</div>
                            <div class="value" id="statTotalEarnings">0đ</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="label">Thu Nhập Tháng Này</div>
                            <div class="value" id="statMonthlyEarnings">0đ</div>
                        </div>
                        <div class="stat-card gold">
                            <div class="label">Số Lượng Mạng Lưới</div>
                            <div class="value" id="statNetworkSize">0</div>
                        </div>
                        <div class="stat-card pink">
                            <div class="label">Trực Tiếp (Level 1)</div>
                            <div class="value" id="statDirectCount">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Hoa Hồng Gần Đây</h3>
                        </div>
                        <div class="card-body">
                            <div id="recentCommissions">
                                <div class="empty-state">Đang tải...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Earnings Page -->
                <div class="page-section" id="page-earnings">
                    <div class="card">
                        <div class="card-header">
                            <h3>Tất Cả Hoa Hồng</h3>
                            <select id="earningsFilter">
                                <option value="">Tất Cả</option>
                                <option value="0">Level 0 (Bản Thân)</option>
                                <option value="1">Level 1</option>
                                <option value="2">Level 2</option>
                                <option value="3">Level 3</option>
                                <option value="4">Level 4</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div id="earningsList">
                                <div class="empty-state">Đang tải...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Thống Kê Theo Cấp</h3>
                        </div>
                        <div class="card-body">
                            <div id="earningsSummary">
                                <div class="empty-state">Đang tải...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Page -->
                <div class="page-section" id="page-network">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mạng Lưới Của Bạn</h3>
                        </div>
                        <div class="card-body">
                            <div id="networkTree">
                                <div class="empty-state">Đang tải...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Danh Sách CTV Trực Tiếp</h3>
                        </div>
                        <div class="card-body">
                            <div id="directDownline">
                                <div class="empty-state">Đang tải...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Page -->
                <div class="page-section" id="page-search">
                    <div class="card">
                        <div class="card-header">
                            <h3>Tìm Kiếm Trong Mạng Lưới</h3>
                        </div>
                        <div class="card-body">
                            <div class="search-container">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                                <input type="text" class="search-input" id="searchInput" placeholder="Tìm theo tên, số điện thoại, email...">
                            </div>
                            <p style="color:#999;font-size:13px;margin-bottom:16px;">
                                Chỉ hiển thị kết quả trong mạng lưới của bạn
                            </p>
                            <div id="searchResults">
                                <div class="empty-state">Nhập từ khóa để tìm kiếm</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let authToken = localStorage.getItem('ctvToken');
        let currentUser = null;

        // API Helper
        async function api(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            };
            
            const response = await fetch(endpoint, { ...options, headers });
            return response.json();
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + 'đ';
        }

        // Remember me - load saved email on page load
        const savedEmail = localStorage.getItem('ctv_remember_email');
        if (savedEmail) {
            document.getElementById('email').value = savedEmail;
            document.getElementById('rememberMe').checked = true;
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            const loginForm = document.getElementById('loginForm');
            const loginSuccess = document.getElementById('loginSuccess');
            
            // Save or remove email based on remember me checkbox
            if (rememberMe) {
                localStorage.setItem('ctv_remember_email', email);
            } else {
                localStorage.removeItem('ctv_remember_email');
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Đang đăng nhập...';
            loginError.classList.remove('show');
            
            const result = await api('/ctv/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.status === 'success') {
                authToken = result.token;
                localStorage.setItem('ctvToken', authToken);
                currentUser = result.ctv;
                
                // Show success animation
                loginForm.style.display = 'none';
                loginSuccess.classList.add('show');
                
                // Wait then show portal
                setTimeout(() => {
                    showPortal();
                }, 1500);
            } else {
                loginError.textContent = result.message || 'Đăng nhập thất bại';
                loginError.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Đăng Nhập';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await api('/ctv/logout', { method: 'POST' });
            authToken = null;
            currentUser = null;
            localStorage.removeItem('ctvToken');
            
            // Redirect to main dashboard
            window.location.href = '/';
        });

        // Show Portal
        async function showPortal() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('portal').classList.add('active');
            await loadProfile();
            await loadRecentCommissions();
        }

        // Check Auth
        async function checkAuth() {
            if (authToken) {
                const result = await api('/ctv/check-auth');
                if (result.authenticated) {
                    showPortal();
                } else {
                    authToken = null;
                    localStorage.removeItem('ctvToken');
                }
            }
        }

        // Load Profile
        async function loadProfile() {
            const result = await api('/api/ctv/me');
            if (result.status === 'success') {
                currentUser = result.profile;
                document.getElementById('userName').textContent = result.profile.ten;
                
                const levelBadge = document.getElementById('userLevel');
                const capBac = (result.profile.cap_bac || 'Bronze').toLowerCase();
                levelBadge.textContent = result.profile.cap_bac || 'Bronze';
                levelBadge.className = 'user-badge ' + capBac;
                
                // Update stats
                document.getElementById('statTotalEarnings').textContent = formatCurrency(result.stats.total_earnings);
                document.getElementById('statMonthlyEarnings').textContent = formatCurrency(result.stats.monthly_earnings);
                document.getElementById('statNetworkSize').textContent = result.stats.network_size;
                document.getElementById('statDirectCount').textContent = result.stats.network_by_level[1] || 0;
            }
        }

        // Load Recent Commissions
        async function loadRecentCommissions() {
            const result = await api('/api/ctv/my-commissions');
            if (result.status === 'success') {
                const container = document.getElementById('recentCommissions');
                if (result.commissions.length === 0) {
                    container.innerHTML = '<div class="empty-state">Chưa có hoa hồng nào</div>';
                    return;
                }
                
                const levelColors = ['#22c55e', '#3b82f6', '#d97706', '#ec4899', '#8b5cf6'];
                
                container.innerHTML = result.commissions.slice(0, 5).map(c => `
                    <div class="commission-item">
                        <div class="left">
                            <div class="level-dot" style="background:${levelColors[c.level]}"></div>
                            <div>
                                <div class="info">Level ${c.level} - ${(c.commission_rate * 100).toFixed(2)}%</div>
                                <div class="date">${c.created_at}</div>
                            </div>
                        </div>
                        <div class="amount">+${formatCurrency(c.commission_amount)}</div>
                    </div>
                `).join('');
            }
        }

        // Load All Commissions
        async function loadAllCommissions(level = '') {
            let url = '/api/ctv/my-commissions';
            if (level) url += `?level=${level}`;
            
            const result = await api(url);
            if (result.status === 'success') {
                const container = document.getElementById('earningsList');
                const levelColors = ['#22c55e', '#3b82f6', '#d97706', '#ec4899', '#8b5cf6'];
                
                if (result.commissions.length === 0) {
                    container.innerHTML = '<div class="empty-state">Không có hoa hồng nào</div>';
                } else {
                    container.innerHTML = result.commissions.map(c => `
                        <div class="commission-item">
                            <div class="left">
                                <div class="level-dot" style="background:${levelColors[c.level]}"></div>
                                <div>
                                    <div class="info">Level ${c.level} - ${(c.commission_rate * 100).toFixed(2)}%</div>
                                    <div class="date">${c.created_at}</div>
                                </div>
                            </div>
                            <div class="amount">+${formatCurrency(c.commission_amount)}</div>
                        </div>
                    `).join('');
                }
                
                // Summary
                const summaryContainer = document.getElementById('earningsSummary');
                if (result.summary.by_level.length === 0) {
                    summaryContainer.innerHTML = '<div class="empty-state">Chưa có dữ liệu</div>';
                } else {
                    summaryContainer.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Số Lượng</th>
                                    <th>Tổng Hoa Hồng</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.summary.by_level.map(s => `
                                    <tr>
                                        <td><span class="level-badge level-${s.level}">Level ${s.level}</span></td>
                                        <td>${s.count}</td>
                                        <td style="color:#22c55e;font-weight:600">${formatCurrency(s.total)}</td>
                                    </tr>
                                `).join('')}
                                <tr style="font-weight:700">
                                    <td>Tổng</td>
                                    <td></td>
                                    <td style="color:#22c55e">${formatCurrency(result.summary.total)}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                }
            }
        }

        // Load Network
        async function loadNetwork() {
            // Load hierarchy tree
            const treeResult = await api('/api/ctv/my-hierarchy');
            if (treeResult.status === 'success') {
                document.getElementById('networkTree').innerHTML = renderTree(treeResult.hierarchy);
            }
            
            // Load direct downline
            const downlineResult = await api('/api/ctv/my-downline');
            if (downlineResult.status === 'success') {
                const container = document.getElementById('directDownline');
                if (downlineResult.downline.length === 0) {
                    container.innerHTML = '<div class="empty-state">Bạn chưa giới thiệu ai</div>';
                } else {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Mã CTV</th>
                                    <th>Tên</th>
                                    <th>Email</th>
                                    <th>SĐT</th>
                                    <th>Cấp Bậc</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${downlineResult.downline.map(d => `
                                    <tr>
                                        <td>${d.ma_ctv}</td>
                                        <td>${d.ten}</td>
                                        <td>${d.email || '-'}</td>
                                        <td>${d.sdt || '-'}</td>
                                        <td>${d.cap_bac || 'Bronze'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            }
        }

        function renderTree(node, level = 0) {
            let html = `
                <div class="tree-node">
                    <div class="node-header">
                        <div>
                            <div class="name">${node.ten} (${node.ma_ctv})</div>
                            <div class="info">${node.email || '-'} | ${node.sdt || '-'}</div>
                        </div>
                        <span class="level-badge level-${node.level}">Level ${node.level}</span>
                    </div>
                </div>
            `;
            
            if (node.children && node.children.length > 0) {
                html += '<div class="tree-children">';
                node.children.forEach(child => {
                    html += renderTree(child, level + 1);
                });
                html += '</div>';
            }
            
            return html;
        }

        // Search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const term = e.target.value.trim();
            
            if (term.length < 2) {
                document.getElementById('searchResults').innerHTML = '<div class="empty-state">Nhập ít nhất 2 ký tự</div>';
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(term), 300);
        });

        async function performSearch(term) {
            document.getElementById('searchResults').innerHTML = '<div class="empty-state">Đang tìm...</div>';
            
            const result = await api(`/api/ctv/my-network/search?q=${encodeURIComponent(term)}`);
            if (result.status === 'success') {
                const container = document.getElementById('searchResults');
                
                if (result.total === 0) {
                    container.innerHTML = '<div class="empty-state">Không tìm thấy kết quả</div>';
                    return;
                }
                
                let html = '';
                
                if (result.ctv_members.length > 0) {
                    html += result.ctv_members.map(c => `
                        <div class="result-item">
                            <div class="type">CTV</div>
                            <div class="name">${c.ten} (${c.ma_ctv})</div>
                            <div class="details">${c.email || '-'} | ${c.sdt || '-'} | ${c.cap_bac || 'Bronze'}</div>
                        </div>
                    `).join('');
                }
                
                if (result.customers.length > 0) {
                    html += result.customers.map(c => `
                        <div class="result-item">
                            <div class="type">Khách Hàng</div>
                            <div class="name">${c.name}</div>
                            <div class="details">${c.phone || '-'} | ${c.email || '-'}</div>
                        </div>
                    `).join('');
                }
                
                container.innerHTML = html;
            }
        }

        // Navigation
        document.querySelectorAll('.sidebar-icon[data-page]').forEach(icon => {
            icon.addEventListener('click', () => {
                const page = icon.dataset.page;
                
                // Update active states
                document.querySelectorAll('.sidebar-icon[data-page]').forEach(i => i.classList.remove('active'));
                icon.classList.add('active');
                
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                
                // Load page data
                if (page === 'earnings') loadAllCommissions();
                if (page === 'network') loadNetwork();
            });
        });

        // Earnings filter
        document.getElementById('earningsFilter').addEventListener('change', (e) => {
            loadAllCommissions(e.target.value);
        });

        // Init
        checkAuth();
    </script>
</body>
</html>
